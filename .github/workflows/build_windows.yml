name: Build Windows

on:
  push:
    tags:
      - "v*.*.*"

jobs:
  build:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v4
        with:
          python-version-file: '.python-version'
      - uses: actions/setup-node@v2
        with:
          node-version-file: '.nvmrc'
      - name: Choco help
        uses: crazy-max/ghaction-chocolatey@v2
        with:
          args: install visualstudio2017buildtools
      - name: Configure visual studio buildtools with npm
        run: npm config set msvs_version 2017
      - name: Install node gyp
        run: npm install --global node-gyp
      - name: Install dependencies
        run: npm ci
      - name: Rebuild dependencies
        run: npm run electron:rebuild
      - name: Configure environment
        run: |
          Set-Content './.env-cmdrc.json' '{ "production": { "NODE_ENV": "production"} }'
          Write-Output "NODE_ENV=production" >> '.env.production'
          Write-Output "SAFE_LINKS=connect-src 'self'" >> '.env.production'
      - name: Build application
        run: npm run make
      - name: Show installer
        run: dir ./out/make/squirrel.windows/x64/
      - name: Create Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          files: |
              ./out/make/squirrel.windows/x64/*
          draft: true




